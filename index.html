<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Med Learner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1020; --card:#121936; --ink:#e9ecf8; --muted:#9aa3bf;
      --accent:#7c9cff; --accent-2:#5fe3c0; --danger:#ff6b6b; --ok:#41d37e;
      --border:rgba(255,255,255,0.08);
    }
    *{box-sizing:border-box}
    body{margin:0; background:linear-gradient(180deg,#0a0f1f,#0b1228); color:var(--ink);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial}
    header{position:sticky; top:0; z-index:10; background:rgba(10,15,35,.85); backdrop-filter:blur(10px);
      border-bottom:1px solid var(--border); padding:12px 16px; display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    header h1{margin:0 12px 0 0; font-size:16px; font-weight:700; letter-spacing:.3px}
    .pill{display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--border); border-radius:12px; background:var(--card)}
    input, select, button, textarea{color:var(--ink); background:#0f1631; border:1px solid var(--border); padding:8px 10px; border-radius:10px; outline:none; font-size:14px}
    input::placeholder, textarea::placeholder{color:var(--muted)}
    button{cursor:pointer; background:linear-gradient(180deg,#1c2553,#152046); border-color:#1e2a60}
    button:hover{filter:brightness(1.07)}
    button.primary{background:linear-gradient(180deg,#5b79ff,#3d57e6)}
    button.ghost{background:transparent}
    .grid{display:grid; grid-template-columns:320px 1fr; gap:16px; padding:16px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px}
    .section-title{font-size:13px; text-transform:uppercase; letter-spacing:.12em; color:var(--muted); margin-bottom:8px}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .stack{display:flex; flex-direction:column; gap:10px}
    .muted{color:var(--muted)}
    .ok{color:var(--ok)} .bad{color:var(--danger)}
    .tag{padding:2px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted); font-size:12px}
    .quote{background:#0e1530; border:1px solid var(--border); border-left:3px solid var(--accent); padding:10px; border-radius:12px; white-space:pre-wrap; line-height:1.35}
    .footerbar{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:10px}
    .linkbar a{color:var(--accent-2); text-decoration:none; margin-right:10px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; background:#0b1330; border:1px solid var(--border); border-radius:6px; padding:2px 6px}
    select[multiple]{min-width:260px; min-height:120px}
    .hidden{display:none !important}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} select[multiple]{min-width:100%} }
    /* login modal */
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center}
    .modal{width:min(560px,92vw); background:var(--card); border:1px solid var(--border); border-radius:16px; padding:20px}
  </style>
</head>
<body>
  <!-- Login / User ID first -->
  <div id="login" class="overlay">
    <div class="modal stack">
      <h2 style="margin:0">Welcome to Med Learner</h2>
      <div class="muted">Enter your <b>user_id</b> to continue. You can change it later from the header.</div>
      <div class="row">
        <label for="loginUser" class="muted">user_id</label>
        <input id="loginUser" value="Gurnoor" size="24" />
      </div>
      <div class="row">
        <button id="btnStart" class="primary">Continue</button>
      </div>
      <div id="loginStatus" class="muted"></div>
    </div>
  </div>

  <header>
    <h1>Med Learner</h1>
    <div class="pill">
      <span class="muted">Base</span>
      <input id="baseUrl" value="https://file-iy1w.onrender.com" size="34" />
      <span id="connDot" class="tag">connecting…</span>
    </div>
    <div class="pill">
      <span class="muted">user_id</span>
      <input id="userId" value="Gurnoor" size="12" />
      <button id="btnLoadTopics">Load Topics</button>
    </div>
    <div class="pill">
      <button id="btnPick" class="primary">Pick</button>
      <button id="btnLearn">Learn</button>
      <button id="btnTest">Test</button>
    </div>
  </header>

  <main class="grid">
    <!-- LEFT -->
    <aside class="stack">
      <div class="card">
        <div class="section-title">Completed Topics</div>
        <div id="completedList" class="stack"></div>
        <div class="footerbar">
          <span class="muted">GET /med/topics</span>
          <button id="btnRefreshTopics" class="ghost">Refresh</button>
        </div>
      </div>

      <div class="card">
        <div class="section-title">TOC Status</div>
        <div id="tocStatus" class="muted">Deriving from standard PDF…</div>
        <div class="row">
          <span class="muted">Disciplines:</span> <span id="discCount" class="tag">0</span>
          <span class="muted">Sub-disciplines:</span> <span id="subCount" class="tag">0</span>
          <span class="muted">Topics:</span> <span id="topicCount" class="tag">0</span>
        </div>
      </div>
    </aside>

    <!-- RIGHT workspace -->
    <section class="stack">
      <!-- PICK MODE -->
      <div class="card stack" id="modePick">
        <div class="section-title">Pick Mode</div>
        <div class="row">
          <div class="stack">
            <div class="muted">1) Choose Disciplines (multi)</div>
            <select id="selDisc" multiple></select>
          </div>
          <div class="stack">
            <div class="muted">2) Choose Sub-disciplines (multi)</div>
            <select id="selSub" multiple disabled></select>
          </div>
          <div class="stack">
            <div class="muted">3) Choose Topic (multi)</div>
            <select id="selTopic" multiple disabled></select>
          </div>
        </div>
        <div class="row">
          <button id="btnPickFromSelections" class="primary">Pick from Selections</button>
          <button id="btnClearSelections" class="ghost">Clear</button>
        </div>
        <div id="pickResult" class="stack"></div>
      </div>

      <!-- LEARN MODE -->
      <div class="card stack hidden" id="modeLearn">
        <div class="section-title">Learn Mode</div>
        <div class="row">
          <span class="muted">Current topic:</span>
          <span id="currentTopic" class="tag">—</span>
          <button id="btnChangeTopic" class="ghost">Change</button>
        </div>

        <div class="stack">
          <div class="row">
            <input id="searchQuery" size="48" placeholder="Search your notes (e.g., 'ACS' OR NSTEMI)" />
            <button id="btnSearch" class="primary">GET /med/pdfs/search</button>
          </div>
          <div id="searchInfo" class="muted"></div>
          <div id="hits" class="stack"></div>
        </div>

        <div class="card" style="background:#0f1736;border:1px dashed var(--border)">
          <div class="section-title">Guideline & Landmark Trial links</div>
          <div class="linkbar" id="extLinks"></div>
          <div class="muted" style="margin-top:8px">Canadian first, then American.</div>
        </div>

        <div class="footerbar">
          <div class="muted">When you’ve learned it, mark complete.</div>
          <button id="btnMarkLearned" class="primary">POST /med/topics</button>
        </div>
        <div id="markStatus" class="muted"></div>
      </div>

      <!-- TEST MODE -->
      <div class="card stack hidden" id="modeTest">
        <div class="section-title">Test Knowledge Mode</div>
        <div class="row">
          <span class="muted">Topic:</span>
          <span id="testTopic" class="tag">—</span>
          <button id="btnBuildQuestions">Build Questions from Hits</button>
          <span id="qCount" class="muted"></span>
        </div>
        <div id="testArea" class="stack"></div>
      </div>
    </section>
  </main>

  <script>
    // ---------------- State ----------------
    const state = {
      baseUrl: 'https://file-iy1w.onrender.com',
      userId: 'Gurnoor',
      connected: false,
      completed: new Set(),

      // TOC
      discToSub: new Map(),     // Map<discipline, Set<sub>>
      subToTopics: new Map(),   // Map<discipline::sub, Set<topic>>
      allTopics: new Set(),

      pickedTopic: null,
      lastDisciplineUsed: null,

      lastHits: [],
      questions: [],
      qIndex: 0
    };

    const $ = id => document.getElementById(id);
    const show = (el, on=true) => el.classList.toggle('hidden', !on);
    const sanitize = s => (s||'').trim();

    // ------------- Header wiring -------------
    $('baseUrl').addEventListener('input', e => state.baseUrl = sanitize(e.target.value));
    $('userId').addEventListener('input', e => state.userId = sanitize(e.target.value)||'Gurnoor');

    // ------------- Login -------------
    $('btnStart').addEventListener('click', async () => {
      state.userId = sanitize($('loginUser').value) || 'Gurnoor';
      $('userId').value = state.userId;
      await connectAndBootstrap();
      $('login').classList.add('hidden'); // move to app after bootstrap
    });

    // ------------- Connect + bootstrap -------------
    async function connectAndBootstrap(){
      const dot = $('connDot');
      dot.textContent = 'connecting…';
      dot.style.color = 'var(--muted)';
      try{
        // /med/topics without user_id should 400; that's OK for connectivity
        const r = await fetch(`${state.baseUrl}/med/topics`);
        state.connected = r.ok || r.status===400;
        dot.textContent = state.connected ? 'connected' : 'disconnected';
        dot.style.color = state.connected ? 'var(--ok)' : 'var(--muted)';
      }catch(e){
        state.connected = false;
        dot.textContent = 'disconnected';
        dot.style.color = 'var(--muted)';
      }

      await loadCompleted();
      await deriveTOCFromStandardPDF();  // build cascading selects
      selectMode('pick');                // default landing
    }

    // ------------- Completed topics -------------
    async function loadCompleted(){
      const list = $('completedList');
      list.innerHTML = '<span class="muted">Loading…</span>';
      try{
        const url = `${state.baseUrl}/med/topics?user_id=${encodeURIComponent(state.userId)}`;
        const r = await fetch(url);
        const j = await r.json();
        state.completed = new Set((j.topics||[]).map(String));
        list.innerHTML = '';
        if(state.completed.size===0){ list.innerHTML = '<span class="muted">None yet.</span>'; return; }
        [...state.completed].forEach(t=>{
          const div = document.createElement('div');
          div.className='row';
          div.innerHTML = `<span class="tag">${t}</span>`;
          list.appendChild(div);
        });
      }catch(err){
        list.innerHTML = `<span class="bad">Failed to load: ${err.message}</span>`;
      }
    }
    $('btnLoadTopics').onclick = loadCompleted;
    $('btnRefreshTopics').onclick = loadCompleted;

    // ------------- Derive TOC from standard PDF -------------
    async function deriveTOCFromStandardPDF(){
      const statusEl = $('tocStatus');
      statusEl.textContent = 'Deriving from standard PDF…';
      // Heuristics: pull many chunks that likely contain lines like "Discipline > Sub > Topic"
      // Try broad queries to get coverage.
      const queries = [
        `" > "`,                       // literal angle bracket separator
        `Discipline`,                  // if the PDF uses labeled headings
        `Subdiscipline OR "Sub-discipline"`,
        `Cardiology OR Nephrology OR Pulmonology OR Neurology OR Gastroenterology OR Endocrinology OR Rheumatology OR Hematology OR Oncology OR Infectious`
      ];

      const texts = [];
      for(const q of queries){
        try{
          const r = await fetch(`${state.baseUrl}/med/pdfs/search?q=${encodeURIComponent(q)}&k=80`);
          const j = await r.json();
          (j.hits||[]).forEach(h => texts.push(h.text));
        }catch(_){}
      }
      // De-dup & combine
      const blob = [...new Set(texts)].join('\n');

      // Parse lines into Discipline > Sub > Topic
      const discToSub = new Map();
      const subToTopics = new Map();
      const allTopics = new Set();

      const push = (disc, sub, topic) => {
        if(!disc || !sub || !topic) return;
        disc = disc.trim(); sub = sub.trim(); topic = topic.trim();
        if(!disc || !sub || !topic) return;
        (discToSub.get(disc) || discToSub.set(disc,new Set()).get(disc)).add(sub);
        const key = `${disc}::${sub}`;
        (subToTopics.get(key) || subToTopics.set(key,new Set()).get(key)).add(topic);
        allTopics.add(topic);
      };

      // Pattern A: "Discipline > Sub > Topic"
      blob.split(/\r?\n/).forEach(line=>{
        const s = line.replace(/^\s*[-*•]\s*/,'').trim();
        if(!s) return;
        // A1 strict >
        let m = s.match(/^([A-Za-z/ &-]+)\s*>\s*([A-Za-z/ &-]+)\s*>\s*(.+)$/);
        if(m){ push(m[1], m[2], m[3]); return; }
        // A2 colon/em-dash separators
        m = s.match(/^([A-Za-z/ &-]+)\s*[:|-|—]\s*([A-Za-z/ &-]+)\s*[:|-|—]\s*(.+)$/);
        if(m){ push(m[1], m[2], m[3]); return; }
        // A3 labeled headings inside a chunk
        m = s.match(/Discipline[:\s-]+([A-Za-z/ &-]+).+Sub[-\s]?discipline[:\s-]+([A-Za-z/ &-]+).+Topic[:\s-]+(.+)/i);
        if(m){ push(m[1], m[2], m[3]); return; }
      });

      // Persist in state
      state.discToSub = discToSub;
      state.subToTopics = subToTopics;
      state.allTopics = allTopics;

      // Update counts
      $('discCount').textContent = String(discToSub.size);
      $('subCount').textContent = String([...subToTopics.keys()].length);
      $('topicCount').textContent = String(allTopics.size);

      // Populate cascading selects
      populateDisciplines();
      statusEl.textContent = discToSub.size ? 'TOC ready (derived from PDF)' : 'No TOC found yet (will still work once notes are searchable).';
    }

    // ------------- Cascading selects for Pick Mode -------------
    const selDisc = $('selDisc'), selSub = $('selSub'), selTopic = $('selTopic');

    function populateDisciplines(){
      selDisc.innerHTML = '';
      const discs = [...state.discToSub.keys()].sort((a,b)=>a.localeCompare(b));
      discs.forEach(d=>{
        const opt = document.createElement('option'); opt.value=d; opt.textContent=d;
        selDisc.appendChild(opt);
      });
      selSub.innerHTML=''; selSub.disabled = true;
      selTopic.innerHTML=''; selTopic.disabled = true;
    }

    selDisc.addEventListener('change', ()=>{
      const chosen = [...selDisc.selectedOptions].map(o=>o.value);
      selSub.innerHTML=''; selTopic.innerHTML=''; selTopic.disabled=true;

      const subs = new Set();
      chosen.forEach(d=>{
        (state.discToSub.get(d)||new Set()).forEach(s=>subs.add(s));
      });
      [...subs].sort((a,b)=>a.localeCompare(b)).forEach(s=>{
        const opt = document.createElement('option'); opt.value=s; opt.textContent=s;
        selSub.appendChild(opt);
      });
      selSub.disabled = subs.size===0;
    });

    selSub.addEventListener('change', ()=>{
      const discs = [...selDisc.selectedOptions].map(o=>o.value);
      const subs = [...selSub.selectedOptions].map(o=>o.value);
      selTopic.innerHTML='';

      const topics = new Set();
      discs.forEach(d=>{
        subs.forEach(s=>{
          const key = `${d}::${s}`;
          (state.subToTopics.get(key)||new Set()).forEach(t=>topics.add(t));
        });
      });
      [...topics].sort((a,b)=>a.localeCompare(b)).forEach(t=>{
        if(state.completed.has(t)) return; // exclude already completed
        const opt = document.createElement('option'); opt.value=t; opt.textContent=t;
        selTopic.appendChild(opt);
      });
      selTopic.disabled = topics.size===0;
    });

    $('btnClearSelections').onclick = ()=>{ populateDisciplines(); $('pickResult').innerHTML=''; };

    function pickFromSelections(){
      // Strategy: prefer first not-yet-completed from selected topics
      const chosen = [...selTopic.selectedOptions].map(o=>o.value);
      const pool = chosen.length ? chosen : [...state.allTopics].filter(t=>!state.completed.has(t));
      if(pool.length===0){ $('pickResult').innerHTML='<span class="bad">No eligible topics.</span>'; return; }
      const topic = pool[0];
      renderPickConfirmation(topic);
    }

    $('btnPickFromSelections').onclick = pickFromSelections;

    function renderPickConfirmation(topic){
      state.pickedTopic = topic;
      const box = $('pickResult'); box.innerHTML='';
      const wrap = document.createElement('div');
      wrap.className='stack';
      wrap.innerHTML = `
        <div class="quote">Topic Selected: ${topic}\nWould you like to confirm this topic?</div>
        <div class="row">
          <button id="btnConfirmPick" class="primary">Yes</button>
          <button id="btnRejectPick">No</button>
        </div>`;
      box.appendChild(wrap);
      $('btnConfirmPick').onclick = ()=>{
        $('currentTopic').textContent = topic;
        $('testTopic').textContent = topic;
        buildGuidelineLinks(topic);
        $('searchQuery').value = topic;
        $('hits').innerHTML = '';
        $('markStatus').textContent = '';
        selectMode('learn');
      };
      $('btnRejectPick').onclick = ()=>{ box.innerHTML='<span class="muted">Okay. Adjust selections and pick again.</span>'; };
    }

    // ------------- Mode switching -------------
    function selectMode(which){
      show($('modePick'), which==='pick');
      show($('modeLearn'), which==='learn');
      show($('modeTest'), which==='test');
    }
    $('btnPick').onclick = ()=>selectMode('pick');
    $('btnLearn').onclick = ()=>selectMode('learn');
    $('btnTest').onclick = ()=>selectMode('test');
    $('btnChangeTopic').onclick = ()=>selectMode('pick');

    // ------------- Learn Mode -------------
    function buildGuidelineLinks(topic){
      const links = $('extLinks'); links.innerHTML='';
      const enc = encodeURIComponent(topic);
      const a = (href, label) => { const el=document.createElement('a'); el.href=href; el.target='_blank'; el.rel='noopener'; el.textContent=label; return el; };
      // Canadian first
      links.appendChild(a(`https://www.google.com/search?q=${enc}+site:cmaj.ca+guideline`, "CMAJ guideline"));
      links.appendChild(a(`https://www.google.com/search?q=${enc}+site:ccs.ca+guideline`, "CCS (Canada)"));
      links.appendChild(a(`https://www.google.com/search?q=${enc}+site:cts-sct.ca+guideline`, "CTS (Canada)"));
      // American
      links.appendChild(a(`https://www.google.com/search?q=${enc}+site:acc.org+guideline`, "ACC"));
      links.appendChild(a(`https://www.google.com/search?q=${enc}+site:ahajournals.org+guideline`, "AHA"));
      links.appendChild(a(`https://www.google.com/search?q=${enc}+site:chestnet.org+guideline`, "CHEST"));
      // Landmark trials
      links.appendChild(a(`https://www.google.com/search?q=${enc}+landmark+trial`, "Landmark trials"));
      links.appendChild(a(`https://scholar.google.com/scholar?q=${enc}+randomized+trial`, "Scholar: RCTs"));
    }

    $('btnSearch').onclick = async ()=>{
      const q = sanitize($('searchQuery').value) || state.pickedTopic || '';
      if(!q){ alert('Enter a query or pick a topic first.'); return; }
      $('hits').innerHTML = '<span class="muted">Searching…</span>';
      $('searchInfo').textContent = '';
      try{
        const url = `${state.baseUrl}/med/pdfs/search?q=${encodeURIComponent(q)}&k=12`;
        const r = await fetch(url);
        const j = await r.json();
        state.lastHits = j.hits || [];
        renderHits(state.lastHits);
        $('searchInfo').textContent = `${state.lastHits.length} chunk(s)`;
      }catch(err){
        $('hits').innerHTML = `<span class="bad">Search failed: ${err.message}</span>`;
      }
    };

    function renderHits(hits){
      const area = $('hits'); area.innerHTML='';
      if(!hits.length){ area.innerHTML='<span class="muted">No matches yet.</span>'; return; }
      hits.forEach((h,i)=>{
        const card = document.createElement('div');
        card.className='quote';
        card.innerHTML = `[${i+1}] ${h.text}`;
        area.appendChild(card);
      });
    }

    $('btnMarkLearned').onclick = async ()=>{
      const topic = state.pickedTopic || sanitize($('currentTopic').textContent);
      if(!topic){ alert('No topic selected.'); return; }
      try{
        const r = await fetch(`${state.baseUrl}/med/topics`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ user_id: state.userId, topic })
        });
        const j = await r.json();
        if(!r.ok) throw new Error(j.error || r.statusText);
        $('markStatus').textContent = `Marked learned: ${topic}`;
        $('markStatus').style.color = 'var(--ok)';
        await loadCompleted();
      }catch(err){
        $('markStatus').textContent = `Failed: ${err.message}`;
        $('markStatus').style.color = 'var(--danger)';
      }
    };

    // ------------- Test Mode (cloze from hits) -------------
    function cloze(text){
      const candidates = [...new Set(
        (text.match(/\b([A-Z]{3,}|[A-Za-z]{6,}|\d+(\.\d+)?\s?(mg|mmol\/L|L|g|mcg|units|%))\b/g) || [])
      )].filter(w => w.length>=4 && w.length<=30).slice(0,12);
      if(!candidates.length) return null;
      const answer = candidates[Math.floor(Math.random()*candidates.length)];
      const stem = text.replace(answer,'_____');
      return { stem, answer };
    }

    $('btnBuildQuestions').onclick = ()=>{
      const used = state.lastHits.slice(0, Math.min(12, state.lastHits.length));
      const qs = [];
      used.forEach(h => { const q = cloze(h.text); if(q) qs.push(q); });
      state.questions = qs; state.qIndex = 0;
      $('qCount').textContent = `${qs.length} question(s) built`;
      renderQuestion();
    };

    function renderQuestion(){
      const area = $('testArea'); area.innerHTML='';
      if(!state.questions.length){
        area.innerHTML = `<span class="muted">No questions yet. Run a search in Learn Mode, then “Build Questions”.</span>`;
        return;
      }
      const q = state.questions[state.qIndex];
      const wrap = document.createElement('div');
      wrap.className='stack';
      wrap.innerHTML = `
        <div class="quote">Listen up. ${state.qIndex+1}/${state.questions.length}. ${q.stem}</div>
        <div class="row">
          <input id="ans" placeholder="Your answer" size="40" />
          <button id="btnSubmit" class="primary">Submit</button>
          <button id="btnReveal" class="ghost">Give up</button>
        </div>
        <div id="feedback" class="muted"></div>
        <div class="footerbar">
          <span class="muted">Mean attending mode: brisk corrections.</span>
          <div>
            <button id="btnPrev" class="ghost">Prev</button>
            <button id="btnNext" class="ghost">Next</button>
          </div>
        </div>
      `;
      area.appendChild(wrap);

      const feedback = $('feedback');
      const nextQ = ()=>{ if(state.qIndex < state.questions.length-1){ state.qIndex++; renderQuestion(); } };
      const prevQ = ()=>{ if(state.qIndex > 0){ state.qIndex--; renderQuestion(); } };
      const check = ()=>{
        const val = sanitize($('ans').value).toLowerCase();
        const ok = val && q.answer.toLowerCase().includes(val);
        if(ok){ feedback.innerHTML = `<span class="ok">Correct.</span>`; setTimeout(nextQ, 700); }
        else { feedback.innerHTML = `<span class="bad">Wrong. Answer: <span class="kbd">${q.answer}</span>.</span>`; }
      };
      $('btnSubmit').onclick = check;
      $('btnReveal').onclick = ()=>{ feedback.innerHTML = `Answer: <span class="kbd">${q.answer}</span>`; };
      $('btnNext').onclick = nextQ;
      $('btnPrev').onclick = prevQ;
    }

    // ------------- Header buttons -------------
    $('btnPick').onclick = ()=>selectMode('pick');
    $('btnLearn').onclick = ()=>selectMode('learn');
    $('btnTest').onclick = ()=>selectMode('test');

    // ------------- Initial auto-connect (shows login first) -------------
    (async function preconnect(){
      // Soft-connect so the dot updates even before login
      try{
        const r = await fetch(`https://file-iy1w.onrender.com/med/topics`);
        const ok = r.ok || r.status===400;
        $('connDot').textContent = ok ? 'connected' : 'disconnected';
        $('connDot').style.color = ok ? 'var(--ok)' : 'var(--muted)';
      }catch(_){
        $('connDot').textContent = 'disconnected';
        $('connDot').style.color = 'var(--muted)';
      }
    })();
  </script>
</body>
</html>
