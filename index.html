<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Med Learner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#0b1020; --card:#121936; --ink:#e9ecf8; --muted:#9aa3bf; --accent:#7c9cff; --accent-2:#5fe3c0; --danger:#ff6b6b; --ok:#41d37e; --border:rgba(255,255,255,0.08); }
    *{box-sizing:border-box}
    body{margin:0; background:linear-gradient(180deg,#0a0f1f,#0b1228); color:var(--ink); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial}
    header{position:sticky; top:0; z-index:10; background:rgba(10,15,35,.85); backdrop-filter:blur(10px); border-bottom:1px solid var(--border); padding:12px 16px; display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    header h1{margin:0 12px 0 0; font-size:16px; font-weight:700; letter-spacing:.3px}
    .pill{display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--border); border-radius:12px; background:var(--card)}
    input, select, button, textarea{color:var(--ink); background:#0f1631; border:1px solid var(--border); padding:8px 10px; border-radius:10px; outline:none; font-size:14px}
    button{cursor:pointer; background:linear-gradient(180deg,#1c2553,#152046); border-color:#1e2a60}
    button:hover{filter:brightness(1.07)}
    button.primary{background:linear-gradient(180deg,#5b79ff,#3d57e6)}
    button.ghost{background:transparent}
    .grid{display:grid; grid-template-columns:320px 1fr; gap:16px; padding:16px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px}
    .section-title{font-size:13px; text-transform:uppercase; letter-spacing:.12em; color:var(--muted); margin-bottom:8px}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .stack{display:flex; flex-direction:column; gap:10px}
    .muted{color:var(--muted)} .ok{color:var(--ok)} .bad{color:var(--danger)}
    .tag{padding:2px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted); font-size:12px}
    .quote{background:#0e1530; border:1px solid var(--border); border-left:3px solid var(--accent); padding:10px; border-radius:12px; white-space:pre-wrap; line-height:1.35}
    .box-title{font-weight:700; margin:0 0 6px 0}
    select[multiple]{min-width:260px; min-height:120px}
    .hidden{display:none !important}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} select[multiple]{min-width:100%} }
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center}
    .modal{width:min(560px,92vw); background:var(--card); border:1px solid var(--border); border-radius:16px; padding:20px}
    .kbd{background:#0c132c;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
    .linkbar a{margin-right:10px}
    .list li{margin:6px 0}
    .disclaimer{font-size:13px; color:var(--muted); padding:8px 12px; border:1px dashed var(--border); border-radius:10px; background:#0e1633}
  </style>
</head>
<body>
  <!-- Login -->
  <div id="login" class="overlay">
    <div class="modal stack">
      <h2 style="margin:0">Welcome to Med Learner</h2>
      <div class="muted">Enter your <b>user_id</b> to continue.</div>
      <div class="row">
        <label for="loginUser" class="muted">user_id</label>
        <input id="loginUser" value="Gurnoor" size="24" />
      </div>
      <div class="row"><button id="btnStart" class="primary">Continue</button></div>
      <div id="loginStatus" class="muted"></div>
    </div>
  </div>

  <header>
    <h1>Med Learner</h1>
    <div class="pill">
      <span class="muted">Base</span>
      <input id="baseUrl" value="https://file-iy1w.onrender.com" size="34" />
      <span id="connDot" class="tag">connectingâ€¦</span>
    </div>
    <div class="pill">
      <span class="muted">user_id</span>
      <input id="userId" value="Gurnoor" size="12" />
      <button id="btnLoadTopics">Load Topics</button>
    </div>
    <div class="pill">
      <button id="btnPick" class="primary">Pick</button>
      <button id="btnLearn">Learn</button>
      <button id="btnTest">Test</button>
    </div>
  </header>

  <main class="grid">
    <aside class="stack">
      <div class="card">
        <div class="section-title">Completed Topics</div>
        <div id="completedList" class="stack"></div>
        <div class="row"><button id="btnRefreshTopics" class="ghost">Refresh</button></div>
      </div>

      <div class="card">
        <div class="section-title">TOC (from server)</div>
        <div id="tocStatus" class="muted">Loadingâ€¦</div>
        <div class="row">
          <span class="muted">Disciplines:</span> <span id="discCount" class="tag">0</span>
          <span class="muted">Sub-disciplines:</span> <span id="subCount" class="tag">0</span>
          <span class="muted">Topics:</span> <span id="topicCount" class="tag">0</span>
        </div>
      </div>
    </aside>

    <section class="stack">
      <!-- PICK -->
      <div class="card stack" id="modePick">
        <div class="section-title">Pick Mode</div>

        <div class="row">
          <div class="stack">
            <div class="row">
              <div class="muted">1) Disciplines</div>
              <button id="btnRandomDisc" class="ghost" title="Random discipline">ðŸŽ² Random</button>
            </div>
            <select id="selDisc" multiple></select>
          </div>

          <div class="stack">
            <div class="row">
              <div class="muted">2) Sub-disciplines</div>
              <button id="btnRandomSub" class="ghost" title="Random sub-discipline" disabled>ðŸŽ² Random</button>
            </div>
            <select id="selSub" multiple disabled></select>
          </div>

          <div class="stack">
            <div class="row">
              <div class="muted">3) Topics</div>
              <button id="btnRandomTopic" class="ghost" title="Random topic" disabled>ðŸŽ² Random</button>
            </div>
            <select id="selTopic" multiple disabled></select>
          </div>
        </div>

        <div class="row">
          <button id="btnPickFromSelections" class="primary">Pick from Selections</button>
          <button id="btnRandomAny" class="ghost">ðŸŽ² Random Any (exclude completed)</button>
          <button id="btnHighYieldIM" class="ghost">âš¡ High-Yield (IM)</button>
          <button id="btnClearSelections" class="ghost">Clear</button>
        </div>
        <div id="pickResult" class="stack"></div>
      </div>

      <!-- LEARN -->
      <div class="card stack hidden" id="modeLearn">
        <div class="section-title">Learn Mode</div>

        <div class="disclaimer">
          Heads up: assembling guidelines, trials, and objectives involves live checks.  
          It can take a few moments â€” thatâ€™s normal.
        </div>

        <div class="row" style="margin-top:6px">
          <span class="muted">Current topic:</span>
          <span id="currentTopic" class="tag">â€”</span>
          <button id="btnChangeTopic" class="ghost">Change</button>
        </div>

        <!-- BOX 1: Guidelines -->
        <div class="card" style="background:#0f1736;border:1px solid var(--border)">
          <h3 class="box-title">Clinical Guidelines (Canadian â†’ USA â†’ International)</h3>
          <div id="guidelinesBox" class="stack"></div>
        </div>

        <!-- BOX 2: Landmark Trials -->
        <div class="card" style="background:#0f1736;border:1px solid var(--border)">
          <h3 class="box-title">Landmark Trials</h3>
          <div id="trialsBox" class="stack"></div>
        </div>

        <!-- BOX 3: Learning Objectives -->
        <div class="card" style="background:#0f1736;border:1px solid var(--border)">
          <h3 class="box-title">Learning Objectives (with resources)</h3>
          <div id="objectivesBox" class="stack"></div>
        </div>

        <div class="stack">
          <div class="row">
            <input id="searchQuery" size="48" placeholder="Optional: search your notes (e.g., 'ACS' OR NSTEMI)" />
            <button id="btnSearch" class="primary">Search Notes</button>
          </div>
          <div id="searchInfo" class="muted"></div>
          <div id="hits" class="stack"></div>
        </div>

        <div class="row">
          <button id="btnMarkLearned" class="primary">Mark as learned</button>
          <span id="markStatus" class="muted"></span>
        </div>
      </div>

      <!-- TEST -->
      <div class="card stack hidden" id="modeTest">
        <div class="section-title">Test Knowledge Mode</div>
        <div class="row">
          <span class="muted">Topic:</span>
          <span id="testTopic" class="tag">â€”</span>
          <button id="btnBuildQuestions" title="Build from hits; if none, use AI" class="primary">Build Questions</button>
          <span id="qCount" class="muted"></span>
        </div>
        <div id="testArea" class="stack"></div>
      </div>
    </section>
  </main>

  <script>
    const state = {
      baseUrl: 'https://file-iy1w.onrender.com',
      userId: 'Gurnoor',
      connected: false,
      completed: new Set(),

      discToSub: new Map(),
      subToTopics: new Map(),
      allTopics: new Set(),

      pickedTopic: null,
      learnPlan: null,
      lastHits: [],
      questions: [],
      qIndex: 0,
      preferAI: false
    };

    const $ = id => document.getElementById(id);
    const show = (el, on=true) => el.classList.toggle('hidden', !on);
    const sanitize = s => (s||'').trim();
    const selDisc = $('selDisc'), selSub = $('selSub'), selTopic = $('selTopic');

    // Login & header
    $('btnStart').onclick = async () => {
      state.userId = sanitize($('loginUser').value) || 'Gurnoor';
      $('userId').value = state.userId;
      await connectAndBootstrap();
      $('login').classList.add('hidden');
    };
    $('baseUrl').oninput = e => state.baseUrl = sanitize(e.target.value);
    $('userId').oninput  = e => state.userId  = sanitize(e.target.value) || 'Gurnoor';
    $('btnPick').onclick  = () => selectMode('pick');
    $('btnLearn').onclick = () => selectMode('learn');
    $('btnTest').onclick  = () => selectMode('test');
    function selectMode(which){ show($('modePick'), which==='pick'); show($('modeLearn'), which==='learn'); show($('modeTest'), which==='test'); }

    function normalizeTopicName(s = "") {
      return String(s)
        .toLowerCase()
        .replace(/^(approach\s*to|evaluation\s*of|diagnosis\s*of|management\s*of|treatment\s*of|overview\s*of)\s+/i, "")
        .replace(/[^\p{L}\p{N}]+/gu, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    // Bootstrap
    async function connectAndBootstrap(){
      const dot = $('connDot');
      dot.textContent = 'connectingâ€¦'; dot.style.color = 'var(--muted)';
      try {
        const r = await fetch(`${state.baseUrl}/med/topics`);
        state.connected = r.ok || r.status === 400;
        dot.textContent = state.connected ? 'connected' : 'disconnected';
        dot.style.color = state.connected ? 'var(--ok)' : 'var(--muted)';
      } catch { dot.textContent='disconnected'; dot.style.color='var(--muted)'; }
      await loadCompleted();
      await fetchTOC();
      selectMode('pick');
    }
    async function loadCompleted(){
      const list = $('completedList');
      list.innerHTML = '<span class="muted">Loadingâ€¦</span>';
      try{
        const r = await fetch(`${state.baseUrl}/med/topics?user_id=${encodeURIComponent(state.userId)}`);
        const j = await r.json();
        state.completed = new Set((j.topics||[]).map(String));
        state.completedNorm = new Set([...(state.completed)].map(normalizeTopicName));
        list.innerHTML = '';
        if(state.completed.size===0){ list.innerHTML = '<span class="muted">None yet.</span>'; return; }
        [...state.completed].forEach(t=>{
          const div = document.createElement('div'); div.className='row';
          div.innerHTML = `<span class="tag">${t}</span>`;
          list.appendChild(div);
        });
      }catch(err){ list.innerHTML = `<span class="bad">${err.message}</span>`; }
    }
    $('btnLoadTopics').onclick = loadCompleted;
    $('btnRefreshTopics').onclick = loadCompleted;

    // TOC
    async function fetchTOC(){
      const s = $('tocStatus'); s.textContent = 'Loadingâ€¦';
      try{
        const r = await fetch(`${state.baseUrl}/med/toc`);
        const j = await r.json(); if(!r.ok) throw new Error(j.error || r.statusText);
        state.discToSub = new Map(); state.subToTopics = new Map(); state.allTopics = new Set();
        (j.items||[]).forEach(it=>{
          const { discipline:d, sub, topic:t } = it; if(!d||!sub||!t) return;
          (state.discToSub.get(d) || state.discToSub.set(d,new Set()).get(d)).add(sub);
          const key = `${d}::${sub}`;
          (state.subToTopics.get(key) || state.subToTopics.set(key,new Set()).get(key)).add(t);
          state.allTopics.add(t);
        });
        $('discCount').textContent  = String(state.discToSub.size);
        $('subCount').textContent   = String([...state.subToTopics.keys()].length);
        $('topicCount').textContent = String(state.allTopics.size);
        populateDisciplines();
        s.textContent = state.allTopics.size ? 'TOC loaded' : 'No TOC items found';
      }catch(err){ s.textContent = `Failed to load TOC: ${err.message}`; s.style.color='var(--danger)'; }
    }
    function populateDisciplines(){
      selDisc.innerHTML=''; [...state.discToSub.keys()].sort().forEach(d=>{ const o=document.createElement('option'); o.value=d; o.textContent=d; selDisc.appendChild(o); });
      selSub.innerHTML=''; selSub.disabled=true; $('btnRandomSub').disabled=true;
      selTopic.innerHTML=''; selTopic.disabled=true; $('btnRandomTopic').disabled=true;
    }
    selDisc.onchange = ()=>{
      const chosen=[...selDisc.selectedOptions].map(o=>o.value);
      selSub.innerHTML=''; selTopic.innerHTML=''; selTopic.disabled=true; $('btnRandomTopic').disabled=true;
      const subs=new Set(); chosen.forEach(d => (state.discToSub.get(d)||new Set()).forEach(s=>subs.add(s)));
      [...subs].sort().forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; selSub.appendChild(o); });
      selSub.disabled = subs.size===0; $('btnRandomSub').disabled = subs.size===0;
    };
    selSub.onchange = () => {
  const discs = [...selDisc.selectedOptions].map(o => o.value);
  const subs  = [...selSub.selectedOptions].map(o => o.value);

  selTopic.innerHTML = '';
  const topics = new Set();

  for (const d of discs) {
    for (const s of subs) {
      const key = `${d}::${s}`;
      const set = state.subToTopics.get(key) || new Set();
      for (const t of set) {
        const tn = normalizeTopicName(t);
        if (!state.completedNorm || !state.completedNorm.has(tn)) {
          topics.add(t);
        }
      }
    }
  }

  for (const t of [...topics].sort()) {
    const o = document.createElement('option');
    o.value = t; o.textContent = t;
    selTopic.appendChild(o);
  }

  selTopic.disabled = topics.size === 0;
  $('btnRandomTopic').disabled = topics.size === 0;
};

    $('btnClearSelections').onclick = ()=>{ populateDisciplines(); $('pickResult').innerHTML=''; };

    // Pick & randomizers
    $('btnPickFromSelections').onclick = ()=>{
      const chosen=[...selTopic.selectedOptions].map(o=>o.value);
      const pool = chosen.length ? chosen : [...state.allTopics].filter(t=>!state.completed.has(t));
      if(!pool.length){ $('pickResult').innerHTML='<span class="bad">No eligible topics.</span>'; return; }
      renderPickConfirmation(pool[0]);
    };
    function setSingle(selectEl, value){ [...selectEl.options].forEach(o=>o.selected=(o.value===value)); selectEl.dispatchEvent(new Event('change')); }
    $('btnRandomDisc').onclick = ()=>{ const arr=[...state.discToSub.keys()]; if(!arr.length) return; setSingle(selDisc, arr[Math.floor(Math.random()*arr.length)]); };
    $('btnRandomSub').onclick = ()=>{
      const discs=[...selDisc.selectedOptions].map(o=>o.value); if(!discs.length) return;
      const subs=new Set(); discs.forEach(d=>(state.discToSub.get(d)||new Set()).forEach(s=>subs.add(s)));
      const arr=[...subs]; if(!arr.length) return; setSingle(selSub, arr[Math.floor(Math.random()*arr.length)]);
    };
    $('btnRandomTopic').onclick = ()=>{
      const discs=[...selDisc.selectedOptions].map(o=>o.value);
      const subs=[...selSub.selectedOptions].map(o=>o.value);
      const topics=new Set();
      discs.forEach(d=>subs.forEach(s=>(state.subToTopics.get(`${d}::${s}`)||new Set()).forEach(t=>{ if(!state.completed.has(t)) topics.add(t); })));
      const arr=[...topics]; if(!arr.length){ alert('No eligible topics.'); return; }
      renderPickConfirmation(arr[Math.floor(Math.random()*arr.length)]);
    };
      $('btnRandomAny').onclick = () => {
        const pool = [...state.allTopics].filter(
          t => !state.completedNorm || !state.completedNorm.has(normalizeTopicName(t))
        );
        if (!pool.length) { alert('No eligible topics.'); return; }
        const pick = pool[Math.floor(Math.random() * pool.length)];
        renderPickConfirmation(pick);
      };


    $('btnHighYieldIM').onclick = async ()=>{
      try{
        const r = await fetch(`${state.baseUrl}/med/high-yield-im`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: state.userId, n: 1 }) });
        const j = await r.json(); if(!r.ok) throw new Error(j.error||'AI pick failed');
        const pick = j.pick || (j.ranked && j.ranked[0]); if(!pick) throw new Error('No AI pick returned');
        renderPickConfirmation(pick.topic, pick.reason);
      }catch(err){ alert(`High-Yield pick failed: ${err.message}`); }
    };

    function renderPickConfirmation(topic, reason){
      state.pickedTopic = topic;
      const box = $('pickResult'); box.innerHTML='';
      const wrap = document.createElement('div'); wrap.className='stack';
      const reasonHtml = reason ? `<div class="muted">AI rationale: ${reason}</div>` : '';
      wrap.innerHTML = `
        <div class="quote">Topic Selected: ${topic}\nWould you like to confirm this topic?</div>
        ${reasonHtml}
        <div class="row">
          <button id="btnConfirmPick" class="primary">Yes</button>
          <button id="btnRejectPick">No</button>
        </div>`;
      box.appendChild(wrap);
      $('btnConfirmPick').onclick = ()=> startLearn(topic);
      $('btnRejectPick').onclick = ()=>{ box.innerHTML='<span class="muted">Okay. Adjust selections and pick again.</span>'; };
    }

    // Learn flow
    async function startLearn(topic){
      $('currentTopic').textContent = topic;
      $('testTopic').textContent = topic;
      $('guidelinesBox').innerHTML = '<span class="muted">Asking AI for guidelinesâ€¦</span>';
      $('trialsBox').innerHTML = '<span class="muted">Asking AI for landmark trialsâ€¦</span>';
      $('objectivesBox').innerHTML = '<span class="muted">Asking AI for learning objectivesâ€¦</span>';
      $('hits').innerHTML = ''; $('searchInfo').textContent = '';
      state.learnPlan = null; selectMode('learn');

      try{
        const r = await fetch(`${state.baseUrl}/med/learn-plan`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ topic, user_id: state.userId }) });
        const j = await r.json(); if(!r.ok) throw new Error(j.error||r.statusText);
        state.learnPlan = j;
        renderGuidelines(j.guidelines||[]); renderTrials(j.trials||[]); renderObjectives(j.objectives||[], j.guidelines||[], j.trials||[]);
      }catch(err){
        $('guidelinesBox').innerHTML = `<span class="bad">${err.message}</span>`;
        $('trialsBox').innerHTML = `<span class="bad">${err.message}</span>`;
        $('objectivesBox').innerHTML = `<span class="bad">${err.message}</span>`;
      }
    }
    function gSearch(q){ return `https://www.google.com/search?q=${encodeURIComponent(q)}`; }
    function pmidSearch(q){ return `https://pubmed.ncbi.nlm.nih.gov/?term=${encodeURIComponent(q)}`; }
    function scholar(q){ return `https://scholar.google.com/scholar?q=${encodeURIComponent(q)}`; }
    function renderGuidelines(list){
      const box=$('guidelinesBox'); box.innerHTML=''; if(!list.length){ box.innerHTML='<span class="muted">None found by AI.</span>'; return; }
      const ul=document.createElement('ul'); ul.className='list';
      list.forEach(g=>{
        const title=`${g.title||''}`.trim(); const org=g.org?` (${g.org})`:'';
        const meta=[g.region,g.year].filter(Boolean).join(' Â· ');
        const link=g.link || gSearch(`${title} ${g.org||''} guideline`);
        const li=document.createElement('li');
        li.innerHTML=`<div><b>${title}</b>${org} â€” <span class="muted">${meta}</span></div><div class="linkbar"><a href="${link}" target="_blank">Open</a></div>${g.why?`<div class="muted">${g.why}</div>`:''}`;
        ul.appendChild(li);
      }); box.appendChild(ul);
    }
    function renderTrials(list){
      const box=$('trialsBox'); box.innerHTML=''; if(!list.length){ box.innerHTML='<span class="muted">None found by AI.</span>'; return; }
      const ul=document.createElement('ul'); ul.className='list';
      list.forEach(t=>{
        const link=t.link || scholar(`${t.name||''} ${state.pickedTopic||''}`);
        const meta=[t.year,t.design,t.n].filter(Boolean).join(' Â· ');
        const li=document.createElement('li');
        li.innerHTML=`<div><b>${t.name||'Trial'}</b> â€” <span class="muted">${meta}</span></div><div class="muted">${t.one_liner||t.result||''}</div><div class="linkbar"><a href="${link}" target="_blank">Open</a><a href="${pmidSearch(t.name||'')}" target="_blank">PubMed</a><a href="${scholar(t.name||'')}" target="_blank">Scholar</a></div>`;
        ul.appendChild(li);
      }); box.appendChild(ul);
    }
    function renderObjectives(objs, guidelines, trials){
      const box=$('objectivesBox'); box.innerHTML=''; if(!objs.length){ box.innerHTML='<span class="muted">None produced by AI.</span>'; return; }
      const gIndex=new Map((guidelines||[]).map(g=>[String(g.title||'').toLowerCase(),g]));
      const tIndex=new Map((trials||[]).map(t=>[String(t.name||'').toLowerCase(),t]));
      objs.forEach(o=>{
        const wrap=document.createElement('div'); wrap.className='stack';
        const header=document.createElement('div'); header.innerHTML=`<b>${o.objective||''}</b>`; wrap.appendChild(header);
        if(o.rationale){ const rat=document.createElement('div'); rat.className='muted'; rat.textContent=o.rationale; wrap.appendChild(rat); }
        const ul=document.createElement('ul'); ul.className='list';
        (o.resources||[]).forEach(r=>{
          const li=document.createElement('li');
          if(r.type==='guideline'){ const key=String(r.ref||'').toLowerCase(); const g=gIndex.get(key);
            const txt=g?`${g.title} (${g.org||''} ${g.year||''})`:(r.ref||'Guideline'); const link=(g&&g.link)||gSearch(`${txt} guideline`);
            li.innerHTML=`ðŸ“˜ ${txt} â€” <a href="${link}" target="_blank">Open</a>`;
          } else if(r.type==='trial'){ const key=String(r.ref||'').toLowerCase(); const t=tIndex.get(key);
            const txt=t?`${t.name} (${t.year||''})`:(r.ref||'Trial'); const link=(t&&t.link)||scholar(txt);
            li.innerHTML=`ðŸ§ª ${txt} â€” <a href="${link}" target="_blank">Open</a>`;
          } else { const title=r.title||'Resource'; const link=r.link||gSearch(`${title} ${state.pickedTopic||''}`); li.innerHTML=`ðŸ”Ž ${title} â€” <a href="${link}" target="_blank">Open</a>`; }
          ul.appendChild(li);
        });
        wrap.appendChild(ul); box.appendChild(wrap);
      });
    }

    // Notes search
    $('btnSearch').onclick = async ()=>{
      const q = sanitize($('searchQuery').value) || state.pickedTopic || '';
      if(!q){ alert('Enter a query or pick a topic first.'); return; }
      $('hits').innerHTML = '<span class="muted">Searchingâ€¦</span>'; $('searchInfo').textContent = '';
      try{
        const r = await fetch(`${state.baseUrl}/med/pdfs/search?q=${encodeURIComponent(q)}&k=12`);
        const j = await r.json(); state.lastHits = j.hits || [];
        renderHits(state.lastHits); $('searchInfo').textContent = `${state.lastHits.length} chunk(s)`;
      }catch(err){ $('hits').innerHTML = `<span class="bad">${err.message}</span>`; }
    };
    function renderHits(hits){
      const area=$('hits'); area.innerHTML='';
      if(!hits.length){ area.innerHTML='<span class="muted">No matches yet.</span>'; return; }
      hits.forEach((h,i)=>{ const card=document.createElement('div'); card.className='quote'; card.innerHTML=`[${i+1}] ${h.text}`; area.appendChild(card); });
    }

    // Mark learned (fixed wiring + disabled state)
    $('btnMarkLearned').addEventListener('click', async ()=>{
      const btn = $('btnMarkLearned');
      const topic = state.pickedTopic || $('currentTopic').textContent.trim();
      if(!topic){ alert('No topic selected.'); return; }
      btn.disabled = true; btn.textContent = 'Savingâ€¦'; $('markStatus').textContent = '';
      try{
        const r = await fetch(`${state.baseUrl}/med/topics`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ user_id: state.userId, topic })
        });
        const j = await r.json();
        if(!r.ok) throw new Error(j.error || r.statusText);
        $('markStatus').textContent = `Marked learned: ${topic}`;
        $('markStatus').style.color = 'var(--ok)';
        await loadCompleted();
      }catch(err){
        $('markStatus').textContent = `Failed: ${err.message}`;
        $('markStatus').style.color = 'var(--danger)';
      } finally {
        btn.disabled = false; btn.textContent = 'Mark as learned';
      }
    });

    // TEST: hits->cloze or AI fallback (unchanged logic)
    function cloze(text){
      const cands=[...new Set((text.match(/\b([A-Z]{3,}|[A-Za-z]{6,}|\d+(?:\.\d+)?\s?(?:mg|mmol\/L|L|g|mcg|units|%))\b/g)||[]))].filter(w=>w.length>=4&&w.length<=30).slice(0,12);
      if(!cands.length) return null; const answer=cands[Math.floor(Math.random()*cands.length)]; const stem=text.replace(answer,'_____'); return { stem, answer };
    }
    $('btnBuildQuestions').onclick = async ()=>{
      const topic = state.pickedTopic || $('testTopic').textContent.trim();
      if(!topic){ alert('Pick a topic first.'); return; }

      if (!state.preferAI && state.lastHits.length){
        const used = state.lastHits.slice(0, Math.min(12, state.lastHits.length));
        state.questions = used.map(h => { const z=cloze(h.text); return z?{ q:z.stem, answer:z.answer, explain:"" }:null; }).filter(Boolean);
        state.qIndex = 0; $('qCount').textContent = `${state.questions.length} question(s) built from notes`;
        return renderQuestion();
      }

      try{
        $('qCount').textContent = 'building (AI)â€¦';
        const r = await fetch(`${state.baseUrl}/med/test-questions`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ topic, n: 12 }) });
        const j = await r.json(); if(!r.ok) throw new Error(j.error||r.statusText);
        state.questions = j.questions || []; state.qIndex = 0;
        $('qCount').textContent = `${state.questions.length} question(s) built (AI)`;
        renderQuestion();
      }catch(err){
        $('qCount').textContent = `failed: ${err.message}`;
        $('testArea').innerHTML = `<span class="bad">${err.message}</span>`;
      }
    };

    function renderQuestion(){
      const area=$('testArea'); area.innerHTML='';
      if(!state.questions.length){ area.innerHTML = `<span class="muted">No questions yet.</span>`; return; }
      const q = state.questions[state.qIndex]; const stem = q.q || q.stem || '';
      const wrap=document.createElement('div'); wrap.className='stack';
      wrap.innerHTML = `
        <div class="quote">Listen up. ${state.qIndex+1}/${state.questions.length}. ${stem}</div>
        <div class="row">
          <input id="ans" placeholder="Your answer" size="40" />
          <button id="btnSubmit" class="primary">Submit</button>
          <button id="btnReveal" class="ghost">Give up</button>
        </div>
        <div id="feedback" class="muted"></div>
        <div class="row">
          <button id="btnPrev" class="ghost">Prev</button>
          <button id="btnNext" class="ghost">Next</button>
        </div>`;
      area.appendChild(wrap);
      const feedback = $('feedback');
      const nextQ = ()=>{ if(state.qIndex < state.questions.length-1){ state.qIndex++; renderQuestion(); } };
      const prevQ = ()=>{ if(state.qIndex > 0){ state.qIndex--; renderQuestion(); } };
      const correct = (val, target) => { const v=(val||'').trim().toLowerCase(); const t=(target||'').trim().toLowerCase(); return v && (t.includes(v) || v===t); };
      $('btnSubmit').onclick = ()=>{
        const val = $('ans').value;
        if (correct(val, q.answer)) { feedback.innerHTML = `<span class="ok">Correct.</span>`; setTimeout(nextQ, 700); }
        else { feedback.innerHTML = `<span class="bad">Wrong.</span> ${q.explain?`<div>${q.explain}</div>`:''} <div class="muted">Answer: <span class="kbd">${q.answer}</span></div>`; }
      };
      $('btnReveal').onclick = ()=>{ feedback.innerHTML = `Answer: <span class="kbd">${q.answer}</span>${q.explain?`<div>${q.explain}</div>`:''}`; };
      $('btnNext').onclick = nextQ; $('btnPrev').onclick = prevQ;
    }

    // Preconnect dot
    (async function preconnect(){
      try{
        const r = await fetch(`https://file-iy1w.onrender.com/med/topics`);
        const ok = r.ok || r.status===400;
        $('connDot').textContent = ok ? 'connected' : 'disconnected';
        $('connDot').style.color = ok ? 'var(--ok)' : 'var(--muted)';
      }catch(_){
        $('connDot').textContent = 'disconnected';
        $('connDot').style.color = 'var(--muted)';
      }
    })();
  </script>
</body>
</html>
