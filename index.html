<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>One Line Pimp Simulator — UI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{
      --bg:#0b0f14;--panel:#121822;--muted:#9fb0c3;--text:#e9f1f7;
      --accent:#6ae3ff;--ok:#3bd280;--bad:#ff6b6b;--border:#243245
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,sans-serif}
    header{
      position:sticky;top:0;z-index:5;background:rgba(11,15,20,.85);backdrop-filter:blur(8px);
      border-bottom:1px solid var(--border)
    }
    .nav{max-width:1000px;margin:0 auto;padding:10px 14px;display:flex;align-items:center;gap:10px}
    .title{font-weight:700}
    .spacer{flex:1}
    .bubble{width:10px;height:10px;border-radius:50%;background:#777;border:1px solid #555;display:inline-block;margin-left:6px;vertical-align:middle}
    .bubble.ok{background:var(--ok);box-shadow:0 0 0 2px rgba(59,210,128,.15)}
    .btn{
      background:#182233;border:1px solid var(--border);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer
    }
    .btn:hover{background:#1f2c42}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    select,input,textarea{
      width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#0c121a;color:var(--text)
    }
    .wrap{max-width:1000px;margin:22px auto;padding:0 14px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px;margin-bottom:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .muted{color:var(--muted)} .mono{font-family:ui-monospace,Menlo,monospace}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .qnum{font-weight:700}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted);margin-left:8px}
    .result{margin-top:10px;padding:12px;border-radius:12px;border:1px solid var(--border)}
    .result.ok{background:rgba(59,210,128,.12);border-color:rgba(59,210,128,.4)}
    .result.bad{background:rgba(255,107,107,.08);border-color:rgba(255,107,107,.35)}
    .rating{font-size:28px;font-weight:900;margin-top:6px}
    .hidden{display:none}
    .right{float:right}
    .center{text-align:center}
  </style>
</head>
<body>

<header>
  <div class="nav">
    <div class="title">AI:</div>
    <select id="aiSelect">
      <option value="pimp">One Line Pimp Simulator</option>
    </select>
    <span id="conn" class="bubble" title="connection status"></span>
    <div id="connTxt" class="muted small"></div>
    <div class="spacer"></div>
    <button id="btnConclude" class="btn" disabled>Update & Conclude</button>
  </div>
</header>

<div class="wrap">
  <!-- Step A: AI selection triggers connection & flow boot -->
  <div id="paneConnect" class="card">
    <h2>Connect</h2>
    <div class="muted">Choose the AI (server is preconfigured). The app will check the connection automatically.</div>
    <div id="connectMsg" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- Step B: choose new / existing user -->
  <div id="paneUserType" class="card hidden">
    <h2>User</h2>
    <div class="row">
      <button class="btn" id="btnNewUser">New user</button>
      <button class="btn" id="btnExistingUser">Existing user</button>
    </div>
  </div>

  <!-- Step C: new user form -->
  <div id="paneNewUser" class="card hidden">
    <h2>Create new user</h2>
    <label>Username (case sensitive)</label>
    <input id="newUsername" placeholder="e.g., Gurnoor"/>
    <div style="margin-top:10px">
      <button class="btn" id="createUser">Create</button>
    </div>
    <div id="newUserMsg" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- Step C2: existing user form -->
  <div id="paneExistingUser" class="card hidden">
    <h2>Sign in existing user</h2>
    <label>Username (case sensitive)</label>
    <input id="existingUsername" placeholder="Your exact username"/>
    <div style="margin-top:10px">
      <button class="btn" id="useExisting">Continue</button>
    </div>
    <div id="existingMsg" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- Step D: show exclusion count + session settings -->
  <div id="paneSettings" class="card hidden">
    <h2>Session Settings</h2>
    <div id="exclInfo" class="muted" style="margin-bottom:8px;"></div>
    <div class="row">
      <div>
        <label>Topic</label>
        <input id="topic" value="random" placeholder="random or e.g., cardiology"/>
      </div>
      <div>
        <label>Starting difficulty</label>
        <select id="difficulty">
          <option>MSI1</option><option>MSI2</option><option selected>MSI3</option><option>MSI4</option>
          <option>R1</option><option>R2</option><option>R3</option><option>R4</option><option>R5</option><option>Attending</option>
        </select>
      </div>
    </div>
    <div style="margin-top:10px">
      <button class="btn" id="startSession">Launch session</button>
    </div>
    <div id="settingsMsg" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- Step E: Q/A area -->
  <div id="paneQA" class="card hidden">
    <div>
      <span class="muted">Question</span>
      <span id="pillDiff" class="pill">—</span>
    </div>
    <div style="margin-top:4px" class="qnum" id="qNum">#—</div>
    <div id="question" style="font-size:20px;margin-top:6px;"></div>

    <div style="margin-top:12px">
      <label>Your answer</label>
      <input id="answer" placeholder="One word or short sentence…"/>
    </div>

    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="submitAnswer">Submit</button>
    </div>

    <div id="resultBox" class="result hidden"></div>

    <div style="margin-top:10px">
      <button id="btnProceed" class="btn hidden">Proceed to next question</button>
    </div>
  </div>

  <!-- Step F: Summary (after conclude) -->
  <div id="paneSummary" class="card hidden center">
    <h2>Session Summary</h2>
    <div id="sumStats" class="muted"></div>
    <div id="sumFeedback" style="margin-top:10px"></div>
    <div id="sumRating" class="rating"></div>
    <div style="margin-top:14px">
      <button class="btn" id="ackSummary">OK</button>
    </div>
  </div>
</div>

<script>
  // ---- Configuration
  const SERVERS = {
    pimp: "https://file-iy1w.onrender.com" // hard-coded server for One Line Pimp Simulator
  };

  // ---- State
  const state = {
    base: "",
    connected: false,
    username: "",
    sessionId: "",
    qNumber: null,
    difficulty: "",
    awaitingProceed: false
  };

  // ---- Helpers
  const $ = (id)=>document.getElementById(id);
  const show = (el, on)=>el.classList.toggle('hidden', !on);
  const setConn = (ok)=>{
    state.connected = ok;
    $('conn').classList.toggle('ok', ok);
    $('connTxt').textContent = ok ? 'connected' : 'disconnected';
  };
  const api = async (path, opts={})=>{
    const url = state.base + path;
    const res = await fetch(url, {
      ...opts,
      headers: { 'Content-Type': 'application/json', ...(opts.headers||{}) }
    });
    const text = await res.text();
    let data; try{ data = JSON.parse(text); }catch{ data = { raw:text }; }
    if(!res.ok){ throw data; }
    return data;
  };
  const errMsg = (e)=> e?.detail || e?.error || 'Unexpected error';

  // ---- Flow boot on AI select
  async function connectAndBoot(){
    const key = $('aiSelect').value;
    state.base = SERVERS[key];
    setConn(false);
    $('connectMsg').textContent = 'Checking connection…';
    try{
      const r = await api('/health');
      setConn(!!r.ok);
      $('connectMsg').textContent = r.ok ? 'Connection established.' : 'Server responded but not healthy.';
      // reveal user type chooser
      if (r.ok){
        show($('paneUserType'), true);
      }
    }catch(e){
      setConn(false);
      $('connectMsg').textContent = 'Connection failed: ' + errMsg(e);
    }
  }

  // ---- User create / existing
  async function showExclusionCountAndSettings(){
    // fetch count
    try{
      const r = await api('/api/exclusions/count?username=' + encodeURIComponent(state.username));
      $('exclInfo').textContent = `You have ${r.count} question(s) in your exclusion list.`;
      show($('paneSettings'), true);
    }catch(e){
      $('exclInfo').textContent = 'Could not fetch exclusions: ' + errMsg(e);
      show($('paneSettings'), true); // still allow a session start for visibility
    }
  }

  // ---- Questions
  async function getNextQuestion(){
    try{
      const r = await api('/api/next', {
        method:'POST',
        body: JSON.stringify({ sessionId: state.sessionId })
      });
      state.qNumber = r.q_number;
      state.difficulty = r.difficulty;
      $('qNum').textContent = `#${state.qNumber}`;
      $('question').textContent = r.question;
      $('pillDiff').textContent = r.difficulty;
      $('answer').value = '';
      show($('resultBox'), false);
      show($('btnProceed'), false);
      state.awaitingProceed = false;
      $('answer').focus();
    }catch(e){
      const msg = 'Failed to get next question: ' + errMsg(e);
      $('resultBox').className = 'result bad';
      $('resultBox').textContent = msg;
      show($('resultBox'), true);
    }
  }

  async function submitAnswer(){
    if(state.awaitingProceed) return; // wait for user to proceed
    const answer = $('answer').value.trim();
    if(!answer){ $('answer').focus(); return; }
    try{
      const r = await api('/api/answer', {
        method:'POST',
        body: JSON.stringify({ sessionId: state.sessionId, answer })
      });
      const box = $('resultBox');
      if (r.correct){
        box.className = 'result ok';
        box.textContent = 'Correct.';
      } else {
        box.className = 'result bad';
        box.textContent = 'Incorrect. ' + (r.explanation || '');
      }
      show(box, true);
      $('pillDiff').textContent = r.nextDifficulty || $('pillDiff').textContent;
      // require user click to proceed
      state.awaitingProceed = true;
      show($('btnProceed'), true);
    }catch(e){
      const box = $('resultBox');
      box.className = 'result bad';
      box.textContent = 'Grading failed: ' + errMsg(e);
      show(box, true);
    }
  }

  // ---- Conclude
  async function conclude(){
    if(!state.sessionId) return;
    $('btnConclude').disabled = true;
    try{
      const r = await api('/api/conclude', {
        method:'POST',
        body: JSON.stringify({ sessionId: state.sessionId })
      });
      $('sumStats').innerHTML = `New exclusion count: <strong>${r.new_count}</strong> · Next number: <strong>${r.next_number}</strong>`;
      $('sumFeedback').textContent = r.feedback || '';
      $('sumRating').textContent = r.rating || '';
      // lock QA pane and show summary until acknowledged
      show($('paneQA'), false);
      show($('paneSummary'), true);
    }catch(e){
      alert('Conclude failed: ' + errMsg(e));
      $('btnConclude').disabled = false;
    }
  }

  function resetToSession(){
    // after acknowledging summary, keep user on settings pane to start again if desired
    $('btnConclude').disabled = false;
    show($('paneSummary'), false);
    show($('paneSettings'), true);
  }

  // ---- Event wiring
  $('aiSelect').addEventListener('change', connectAndBoot);
  window.addEventListener('load', connectAndBoot);

  $('btnNewUser').addEventListener('click', ()=>{
    show($('paneNewUser'), true);
    show($('paneExistingUser'), false);
  });
  $('btnExistingUser').addEventListener('click', ()=>{
    show($('paneExistingUser'), true);
    show($('paneNewUser'), false);
  });

  $('createUser').addEventListener('click', async ()=>{
    const u = $('newUsername').value.trim();
    if(!u){ $('newUserMsg').textContent = 'Please enter a username.'; return; }
    try{
      await api('/api/users',{ method:'POST', body: JSON.stringify({ username: u })});
      state.username = u;
      $('newUserMsg').textContent = `User "${u}" created.`;
      show($('paneUserType'), false);
      show($('paneNewUser'), false);
      await showExclusionCountAndSettings();
    }catch(e){
      $('newUserMsg').textContent = errMsg(e);
    }
  });

  $('useExisting').addEventListener('click', async ()=>{
    const u = $('existingUsername').value.trim();
    if(!u){ $('existingMsg').textContent = 'Please enter your username.'; return; }
    try{
      // simple existence check: exclusions/count will work even if 0
      await api('/api/exclusions/count?username=' + encodeURIComponent(u));
      state.username = u;
      $('existingMsg').textContent = `Welcome back, ${u}.`;
      show($('paneUserType'), false);
      show($('paneExistingUser'), false);
      await showExclusionCountAndSettings();
    }catch(e){
      $('existingMsg').textContent = errMsg(e);
    }
  });

  $('startSession').addEventListener('click', async ()=>{
    try{
      const topic = $('topic').value.trim() || 'random';
      const startingDifficulty = $('difficulty').value;
      const r = await api('/api/sessions', {
        method:'POST',
        body: JSON.stringify({ username: state.username, topic, startingDifficulty })
      });
      state.sessionId = r.sessionId;
      state.difficulty = r.difficulty;
      $('pillDiff').textContent = state.difficulty;
      // show QA pane, make conclude button available
      show($('paneSettings'), false);
      show($('paneQA'), true);
      $('btnConclude').disabled = false;
      // fetch first question
      await getNextQuestion();
    }catch(e){
      $('settingsMsg').textContent = 'Failed to start session: ' + errMsg(e);
    }
  });

  $('submitAnswer').addEventListener('click', submitAnswer);
  $('btnProceed').addEventListener('click', getNextQuestion);
  $('btnConclude').addEventListener('click', conclude);
  $('ackSummary').addEventListener('click', resetToSession);
</script>
</body>
</html>
