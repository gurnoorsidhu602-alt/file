<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Med Learner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#0b1020; --card:#121936; --ink:#e9ecf8; --muted:#9aa3bf; --accent:#7c9cff; --accent-2:#5fe3c0; --danger:#ff6b6b; --ok:#41d37e; --border:rgba(255,255,255,0.08); }
    *{box-sizing:border-box}
    body{margin:0; background:linear-gradient(180deg,#0a0f1f,#0b1228); color:var(--ink); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial}
    header{position:sticky; top:0; z-index:10; background:rgba(10,15,35,.85); backdrop-filter:blur(10px); border-bottom:1px solid var(--border); padding:12px 16px; display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    header h1{margin:0 12px 0 0; font-size:16px; font-weight:700; letter-spacing:.3px}
    .pill{display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--border); border-radius:12px; background:var(--card)}
    input, select, button, textarea{color:var(--ink); background:#0f1631; border:1px solid var(--border); padding:8px 10px; border-radius:10px; outline:none; font-size:14px}
    button{cursor:pointer; background:linear-gradient(180deg,#1c2553,#152046); border-color:#1e2a60}
    button:hover{filter:brightness(1.07)}
    button.primary{background:linear-gradient(180deg,#5b79ff,#3d57e6)}
    button.ghost{background:transparent}
    .grid{display:grid; grid-template-columns:320px 1fr; gap:16px; padding:16px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px}
    .section-title{font-size:13px; text-transform:uppercase; letter-spacing:.12em; color:var(--muted); margin-bottom:8px}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .stack{display:flex; flex-direction:column; gap:10px}
    .muted{color:var(--muted)} .ok{color:var(--ok)} .bad{color:var(--danger)}
    .tag{padding:2px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted); font-size:12px}
    .quote{background:#0e1530; border:1px solid var(--border); border-left:3px solid var(--accent); padding:10px; border-radius:12px; white-space:pre-wrap; line-height:1.35}
    select[multiple]{min-width:260px; min-height:120px}
    .hidden{display:none !important}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} select[multiple]{min-width:100%} }
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center}
    .modal{width:min(560px,92vw); background:var(--card); border:1px solid var(--border); border-radius:16px; padding:20px}
    .kbd{background:#0c132c;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <!-- Login -->
  <div id="login" class="overlay">
    <div class="modal stack">
      <h2 style="margin:0">Welcome to Med Learner</h2>
      <div class="muted">Enter your <b>user_id</b> to continue.</div>
      <div class="row">
        <label for="loginUser" class="muted">user_id</label>
        <input id="loginUser" value="Gurnoor" size="24" />
      </div>
      <div class="row"><button id="btnStart" class="primary">Continue</button></div>
      <div id="loginStatus" class="muted"></div>
    </div>
  </div>

  <header>
    <h1>Med Learner</h1>
    <div class="pill">
      <span class="muted">Base</span>
      <input id="baseUrl" value="https://file-iy1w.onrender.com" size="34" />
      <span id="connDot" class="tag">connecting…</span>
    </div>
    <div class="pill">
      <span class="muted">user_id</span>
      <input id="userId" value="Gurnoor" size="12" />
      <button id="btnLoadTopics">Load Topics</button>
    </div>
    <div class="pill">
      <button id="btnPick" class="primary">Pick</button>
      <button id="btnLearn">Learn</button>
      <button id="btnTest">Test</button>
    </div>
  </header>

  <main class="grid">
    <aside class="stack">
      <div class="card">
        <div class="section-title">Completed Topics</div>
        <div id="completedList" class="stack"></div>
        <div class="footerbar">
          <span class="muted">GET /med/topics</span>
          <button id="btnRefreshTopics" class="ghost">Refresh</button>
        </div>
      </div>

      <div class="card">
        <div class="section-title">TOC (from server)</div>
        <div id="tocStatus" class="muted">Loading…</div>
        <div class="row">
          <span class="muted">Disciplines:</span> <span id="discCount" class="tag">0</span>
          <span class="muted">Sub-disciplines:</span> <span id="subCount" class="tag">0</span>
          <span class="muted">Topics:</span> <span id="topicCount" class="tag">0</span>
        </div>
      </div>
    </aside>

    <section class="stack">
      <!-- PICK -->
      <div class="card stack" id="modePick">
        <div class="section-title">Pick Mode</div>

        <div class="row">
          <div class="stack">
            <div class="row">
              <div class="muted">1) Disciplines</div>
              <button id="btnRandomDisc" class="ghost" title="Random discipline">🎲 Random</button>
            </div>
            <select id="selDisc" multiple></select>
          </div>

          <div class="stack">
            <div class="row">
              <div class="muted">2) Sub-disciplines</div>
              <button id="btnRandomSub" class="ghost" title="Random sub-discipline" disabled>🎲 Random</button>
            </div>
            <select id="selSub" multiple disabled></select>
          </div>

          <div class="stack">
            <div class="row">
              <div class="muted">3) Topics</div>
              <button id="btnRandomTopic" class="ghost" title="Random topic" disabled>🎲 Random</button>
            </div>
            <select id="selTopic" multiple disabled></select>
          </div>
        </div>

        <div class="row">
          <button id="btnPickFromSelections" class="primary">Pick from Selections</button>
          <button id="btnRandomAny" class="ghost">🎲 Random Any (exclude completed)</button>
          <button id="btnHighYieldIM" class="ghost">⚡ High-Yield (IM)</button>
          <button id="btnClearSelections" class="ghost">Clear</button>
        </div>
        <div id="pickResult" class="stack"></div>
      </div>

      <!-- LEARN -->
      <div class="card stack hidden" id="modeLearn">
        <div class="section-title">Learn Mode</div>
        <div class="row">
          <span class="muted">Current topic:</span>
          <span id="currentTopic" class="tag">—</span>
          <button id="btnChangeTopic" class="ghost">Change</button>
        </div>

        <div class="stack">
          <div class="row">
            <input id="searchQuery" size="48" placeholder="Search your notes (e.g., 'ACS' OR NSTEMI)" />
            <button id="btnSearch" class="primary">GET /med/pdfs/search</button>
          </div>
          <div id="searchInfo" class="muted"></div>
          <div id="hits" class="stack"></div>
        </div>

        <div class="card" style="background:#0f1736;border:1px dashed var(--border)">
          <div class="section-title">Guideline & Landmark Trial links</div>
          <div class="linkbar" id="extLinks"></div>
          <div class="muted" style="margin-top:8px">Canadian first, then American.</div>
        </div>

        <div class="footerbar">
          <div class="muted">When you’ve learned it, mark complete.</div>
          <button id="btnMarkLearned" class="primary">POST /med/topics</button>
        </div>
        <div id="markStatus" class="muted"></div>
      </div>

      <!-- TEST -->
      <div class="card stack hidden" id="modeTest">
        <div class="section-title">Test Knowledge Mode</div>
        <div class="row">
          <span class="muted">Topic:</span>
          <span id="testTopic" class="tag">—</span>
          <button id="btnBuildQuestions">Build Questions from Hits</button>
          <span id="qCount" class="muted"></span>
        </div>
        <div id="testArea" class="stack"></div>
      </div>
    </section>
  </main>

  <script>
    // ---------- State ----------
    const state = {
      baseUrl: 'https://file-iy1w.onrender.com',
      userId: 'Gurnoor',
      connected: false,
      completed: new Set(),

      // TOC structures
      discToSub: new Map(),          // Map<discipline, Set<sub>>
      subToTopics: new Map(),        // Map<discipline::sub, Set<topic>>
      allTopics: new Set(),

      pickedTopic: null,
      lastHits: [],
      questions: [],
      qIndex: 0
    };

    const $ = id => document.getElementById(id);
    const show = (el, on=true) => el.classList.toggle('hidden', !on);
    const sanitize = s => (s||'').trim();

    const selDisc = $('selDisc'), selSub = $('selSub'), selTopic = $('selTopic');

    // ---------- Login ----------
    $('btnStart').onclick = async () => {
      state.userId = sanitize($('loginUser').value) || 'Gurnoor';
      $('userId').value = state.userId;
      await connectAndBootstrap();
      $('login').classList.add('hidden');
    };

    // ---------- Header ----------
    $('baseUrl').oninput = e => state.baseUrl = sanitize(e.target.value);
    $('userId').oninput  = e => state.userId  = sanitize(e.target.value) || 'Gurnoor';

    $('btnPick').onclick  = () => selectMode('pick');
    $('btnLearn').onclick = () => selectMode('learn');
    $('btnTest').onclick  = () => selectMode('test');

    function selectMode(which){
      show($('modePick'), which==='pick');
      show($('modeLearn'), which==='learn');
      show($('modeTest'), which==='test');
    }

    // ---------- Connectivity + bootstrap ----------
    async function connectAndBootstrap(){
      const dot = $('connDot');
      dot.textContent = 'connecting…'; dot.style.color = 'var(--muted)';
      try {
        const r = await fetch(`${state.baseUrl}/med/topics`);
        state.connected = r.ok || r.status === 400;
        dot.textContent = state.connected ? 'connected' : 'disconnected';
        dot.style.color = state.connected ? 'var(--ok)' : 'var(--muted)';
      } catch(e) {
        state.connected = false; dot.textContent = 'disconnected'; dot.style.color = 'var(--muted)';
      }
      await loadCompleted();
      await fetchTOC();        // TOC from /med/toc
      selectMode('pick');
    }

    async function loadCompleted(){
      const list = $('completedList');
      list.innerHTML = '<span class="muted">Loading…</span>';
      try{
        const r = await fetch(`${state.baseUrl}/med/topics?user_id=${encodeURIComponent(state.userId)}`);
        const j = await r.json();
        state.completed = new Set((j.topics||[]).map(String));
        list.innerHTML = '';
        if(state.completed.size===0){ list.innerHTML = '<span class="muted">None yet.</span>'; return; }
        [...state.completed].forEach(t=>{
          const div = document.createElement('div'); div.className='row';
          div.innerHTML = `<span class="tag">${t}</span>`;
          list.appendChild(div);
        });
      }catch(err){
        list.innerHTML = `<span class="bad">Failed to load: ${err.message}</span>`;
      }
    }
    $('btnLoadTopics').onclick = loadCompleted;
    $('btnRefreshTopics').onclick = loadCompleted;

    // ---------- Fetch TOC ----------
    async function fetchTOC(){
      const s = $('tocStatus');
      s.textContent = 'Loading…';
      try{
        const r = await fetch(`${state.baseUrl}/med/toc`);
        const j = await r.json();
        if(!r.ok) throw new Error(j.error || r.statusText);

        // Build maps
        state.discToSub = new Map();
        state.subToTopics = new Map();
        state.allTopics = new Set();

        (j.items || []).forEach(it=>{
          const { discipline: d, sub: sub, topic: t } = it;
          if(!d || !sub || !t) return;
          (state.discToSub.get(d) || state.discToSub.set(d, new Set()).get(d)).add(sub);
          const key = `${d}::${sub}`;
          (state.subToTopics.get(key) || state.subToTopics.set(key, new Set()).get(key)).add(t);
          state.allTopics.add(t);
        });

        // Counts
        $('discCount').textContent  = String(state.discToSub.size);
        $('subCount').textContent   = String([...state.subToTopics.keys()].length);
        $('topicCount').textContent = String(state.allTopics.size);

        populateDisciplines();
        s.textContent = state.allTopics.size ? 'TOC loaded' : 'No TOC items found';
      }catch(err){
        s.textContent = `Failed to load TOC: ${err.message}`;
        s.style.color = 'var(--danger)';
      }
    }

    // ---------- Populate / selection flow ----------
    function populateDisciplines(){
      selDisc.innerHTML = '';
      const discs = [...state.discToSub.keys()].sort((a,b)=>a.localeCompare(b));
      discs.forEach(d=>{
        const opt = document.createElement('option'); opt.value=d; opt.textContent=d;
        selDisc.appendChild(opt);
      });
      selSub.innerHTML=''; selSub.disabled = true; $('btnRandomSub').disabled = true;
      selTopic.innerHTML=''; selTopic.disabled = true; $('btnRandomTopic').disabled = true;
    }

    selDisc.onchange = ()=>{
      const chosen = [...selDisc.selectedOptions].map(o=>o.value);
      selSub.innerHTML=''; selTopic.innerHTML=''; selTopic.disabled=true; $('btnRandomTopic').disabled = true;

      const subs = new Set();
      chosen.forEach(d => (state.discToSub.get(d)||new Set()).forEach(s=>subs.add(s)));
      [...subs].sort((a,b)=>a.localeCompare(b)).forEach(s=>{
        const opt = document.createElement('option'); opt.value=s; opt.textContent=s;
        selSub.appendChild(opt);
      });
      selSub.disabled = subs.size===0;
      $('btnRandomSub').disabled = subs.size===0;
    };

    selSub.onchange = ()=>{
      const discs = [...selDisc.selectedOptions].map(o=>o.value);
      const subs  = [...selSub.selectedOptions].map(o=>o.value);
      selTopic.innerHTML='';

      const topics = new Set();
      discs.forEach(d=>{
        subs.forEach(s=>{
          const key = `${d}::${s}`;
          (state.subToTopics.get(key)||new Set()).forEach(t=>topics.add(t));
        });
      });
      [...topics].sort((a,b)=>a.localeCompare(b)).forEach(t=>{
        if(state.completed.has(t)) return; // exclude completed
        const opt = document.createElement('option'); opt.value=t; opt.textContent=t;
        selTopic.appendChild(opt);
      });
      selTopic.disabled = topics.size===0;
      $('btnRandomTopic').disabled = topics.size===0;
    };

    $('btnClearSelections').onclick = ()=>{ populateDisciplines(); $('pickResult').innerHTML=''; };

    $('btnPickFromSelections').onclick = ()=>{
      const chosen = [...selTopic.selectedOptions].map(o=>o.value);
      const pool = chosen.length ? chosen : [...state.allTopics].filter(t=>!state.completed.has(t));
      if(!pool.length){ $('pickResult').innerHTML='<span class="bad">No eligible topics.</span>'; return; }
      renderPickConfirmation(pool[0]);
    };

    // ---------- Randomizers ----------
    function setSingle(selectEl, value){
      [...selectEl.options].forEach(o => o.selected = (o.value === value));
      selectEl.dispatchEvent(new Event('change'));
    }
    $('btnRandomDisc').onclick = ()=>{
      const discs = [...state.discToSub.keys()];
      if(!discs.length) return;
      const pick = discs[Math.floor(Math.random()*discs.length)];
      setSingle(selDisc, pick);
    };
    $('btnRandomSub').onclick = ()=>{
      const discs = [...selDisc.selectedOptions].map(o=>o.value);
      if(!discs.length) return;
      const subs = new Set();
      discs.forEach(d => (state.discToSub.get(d)||new Set()).forEach(s=>subs.add(s)));
      const arr = [...subs];
      if(!arr.length) return;
      const pick = arr[Math.floor(Math.random()*arr.length)];
      setSingle(selSub, pick);
    };
    $('btnRandomTopic').onclick = ()=>{
      const discs = [...selDisc.selectedOptions].map(o=>o.value);
      const subs  = [...selSub.selectedOptions].map(o=>o.value);
      const topics = new Set();
      discs.forEach(d => subs.forEach(s => (state.subToTopics.get(`${d}::${s}`)||new Set()).forEach(t => {
        if(!state.completed.has(t)) topics.add(t);
      })));
      const arr = [...topics];
      if(!arr.length){ alert('No eligible topics in this selection.'); return; }
      const pick = arr[Math.floor(Math.random()*arr.length)];
      renderPickConfirmation(pick);
    };
    $('btnRandomAny').onclick = ()=>{
      const pool = [...state.allTopics].filter(t=>!state.completed.has(t));
      if(!pool.length){ alert('No eligible topics.'); return; }
      const pick = pool[Math.floor(Math.random()*pool.length)];
      renderPickConfirmation(pick);
    };

    // ---------- High-Yield (IM) via server AI ----------
    $('btnHighYieldIM').onclick = async ()=>{
      const body = { user_id: state.userId, n: 1 };
      try{
        const r = await fetch(`${state.baseUrl}/med/high-yield-im`, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        const j = await r.json();
        if(!r.ok) throw new Error(j.error || 'AI pick failed');
        const pick = j.pick || (j.ranked && j.ranked[0]);
        if(!pick) throw new Error('No AI pick returned');
        renderPickConfirmation(pick.topic, pick.reason);
      }catch(err){
        alert(`High-Yield pick failed: ${err.message}`);
      }
    };

    // ---------- Confirm pick ----------
    function renderPickConfirmation(topic, reason){
      state.pickedTopic = topic;
      const box = $('pickResult'); box.innerHTML='';
      const wrap = document.createElement('div');
      wrap.className='stack';
      const reasonHtml = reason ? `<div class="muted">AI rationale: ${reason}</div>` : '';
      wrap.innerHTML = `
        <div class="quote">Topic Selected: ${topic}\nWould you like to confirm this topic?</div>
        ${reasonHtml}
        <div class="row">
          <button id="btnConfirmPick" class="primary">Yes</button>
          <button id="btnRejectPick">No</button>
        </div>`;
      box.appendChild(wrap);
      $('btnConfirmPick').onclick = ()=>{
        $('currentTopic').textContent = topic;
        $('testTopic').textContent = topic;
        buildGuidelineLinks(topic);
        $('searchQuery').value = topic;
        $('hits').innerHTML = '';
        $('markStatus').textContent = '';
        selectMode('learn');
      };
      $('btnRejectPick').onclick = ()=>{ box.innerHTML='<span class="muted">Okay. Adjust selections and pick again.</span>'; };
    }

    // ---------- Learn ----------
    function buildGuidelineLinks(topic){
      const links = $('extLinks'); links.innerHTML='';
      const enc = encodeURIComponent(topic);
      const a = (href, label) => { const el=document.createElement('a'); el.href=href; el.target='_blank'; el.rel='noopener'; el.textContent=label; el.style.marginRight='10px'; return el; };
      links.appendChild(a(`https://www.google.com/search?q=${enc}+site:cmaj.ca+guideline`, "CMAJ guideline"));
      links.appendChild(a(`https://www.google.com/search?q=${enc}+site:ccs.ca+guideline`, "CCS (Canada)"));
      links.appendChild(a(`https://www.google.com/search?q=${enc}+site:cts-sct.ca+guideline`, "CTS (Canada)"));
      links.appendChild(a(`https://www.google.com/search?q=${enc}+site:acc.org+guideline`, "ACC"));
      links.appendChild(a(`https://www.google.com/search?q=${enc}+site:ahajournals.org+guideline`, "AHA"));
      links.appendChild(a(`https://www.google.com/search?q=${enc}+site:chestnet.org+guideline`, "CHEST"));
      links.appendChild(a(`https://www.google.com/search?q=${enc}+landmark+trial`, "Landmark trials"));
      links.appendChild(a(`https://scholar.google.com/scholar?q=${enc}+randomized+trial`, "Scholar: RCTs"));
    }

    $('btnSearch').onclick = async ()=>{
      const q = sanitize($('searchQuery').value) || state.pickedTopic || '';
      if(!q){ alert('Enter a query or pick a topic first.'); return; }
      $('hits').innerHTML = '<span class="muted">Searching…</span>'; $('searchInfo').textContent = '';
      try{
        const r = await fetch(`${state.baseUrl}/med/pdfs/search?q=${encodeURIComponent(q)}&k=12`);
        const j = await r.json();
        state.lastHits = j.hits || [];
        renderHits(state.lastHits);
        $('searchInfo').textContent = `${state.lastHits.length} chunk(s)`;
      }catch(err){
        $('hits').innerHTML = `<span class="bad">Search failed: ${err.message}</span>`;
      }
    };

    function renderHits(hits){
      const area = $('hits'); area.innerHTML='';
      if(!hits.length){ area.innerHTML='<span class="muted">No matches yet.</span>'; return; }
      hits.forEach((h,i)=>{
        const card = document.createElement('div'); card.className='quote'; card.innerHTML = `[${i+1}] ${h.text}`;
        area.appendChild(card);
      });
    }

    $('btnMarkLearned').onclick = async ()=>{
      const topic = state.pickedTopic || sanitize($('currentTopic').textContent);
      if(!topic){ alert('No topic selected.'); return; }
      try{
        const r = await fetch(`${state.baseUrl}/med/topics`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ user_id: state.userId, topic })
        });
        const j = await r.json();
        if(!r.ok) throw new Error(j.error || r.statusText);
        $('markStatus').textContent = `Marked learned: ${topic}`;
        $('markStatus').style.color = 'var(--ok)';
        await loadCompleted();
      }catch(err){
        $('markStatus').textContent = `Failed: ${err.message}`;
        $('markStatus').style.color = 'var(--danger)';
      }
    };

    // ---------- Test (cloze from hits) ----------
    function cloze(text){
      const cands = [...new Set((text.match(/\b([A-Z]{3,}|[A-Za-z]{6,}|\d+(\.\d+)?\s?(mg|mmol\/L|L|g|mcg|units|%))\b/g) || []))].filter(w => w.length>=4 && w.length<=30).slice(0,12);
      if(!cands.length) return null;
      const answer = cands[Math.floor(Math.random()*cands.length)];
      const stem = text.replace(answer, '_____');
      return { stem, answer };
    }
    $('btnBuildQuestions').onclick = ()=>{
      const used = state.lastHits.slice(0, Math.min(12, state.lastHits.length));
      state.questions = used.map(h => cloze(h.text)).filter(Boolean);
      state.qIndex = 0; $('qCount').textContent = `${state.questions.length} question(s) built`; renderQuestion();
    };
    function renderQuestion(){
      const area = $('testArea'); area.innerHTML='';
      if(!state.questions.length){ area.innerHTML = `<span class="muted">No questions yet. Search in Learn Mode, then “Build Questions”.</span>`; return; }
      const q = state.questions[state.qIndex];
      const wrap = document.createElement('div'); wrap.className='stack';
      wrap.innerHTML = `
        <div class="quote">Listen up. ${state.qIndex+1}/${state.questions.length}. ${q.stem}</div>
        <div class="row">
          <input id="ans" placeholder="Your answer" size="40" />
          <button id="btnSubmit" class="primary">Submit</button>
          <button id="btnReveal" class="ghost">Give up</button>
        </div>
        <div id="feedback" class="muted"></div>
        <div class="footerbar">
          <span class="muted">Mean attending mode: brisk corrections.</span>
          <div>
            <button id="btnPrev" class="ghost">Prev</button>
            <button id="btnNext" class="ghost">Next</button>
          </div>
        </div>`;
      area.appendChild(wrap);
      const feedback = $('feedback');
      const nextQ = ()=>{ if(state.qIndex < state.questions.length-1){ state.qIndex++; renderQuestion(); } };
      const prevQ = ()=>{ if(state.qIndex > 0){ state.qIndex--; renderQuestion(); } };
      const check = ()=>{
        const val = (document.getElementById('ans').value||'').trim().toLowerCase();
        const ok = val && q.answer.toLowerCase().includes(val);
        if(ok){ feedback.innerHTML = `<span class="ok">Correct.</span>`; setTimeout(nextQ, 700); }
        else { feedback.innerHTML = `<span class="bad">Wrong. Answer: <span class="kbd">${q.answer}</span>.</span>`; }
      };
      document.getElementById('btnSubmit').onclick = check;
      document.getElementById('btnReveal').onclick = ()=>{ feedback.innerHTML = `Answer: <span class="kbd">${q.answer}</span>`; };
      document.getElementById('btnNext').onclick = nextQ;
      document.getElementById('btnPrev').onclick = prevQ;
    }

    // ---------- Preconnect (header dot) ----------
    (async function preconnect(){
      try{
        const r = await fetch(`https://file-iy1w.onrender.com/med/topics`);
        const ok = r.ok || r.status===400;
        $('connDot').textContent = ok ? 'connected' : 'disconnected';
        $('connDot').style.color = ok ? 'var(--ok)' : 'var(--muted)';
      }catch(_){
        $('connDot').textContent = 'disconnected';
        $('connDot').style.color = 'var(--muted)';
      }
    })();
  </script>
</body>
</html>
